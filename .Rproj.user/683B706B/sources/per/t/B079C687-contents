---
title: "Анализ точечных паттернов и кластеризация"
format: html
---

Материалы лекции

```{=html}
<iframe src="https://baltti.github.io/point-pattern/" width="1000" height="500"></iframe>
```

[Открыть лекцию в новой вкладке](https://baltti.github.io/point-pattern/){target="_blank"}

Для практической работы по теме используется геоинформационная система [QGIS](https://qgis.org/).

::: callout-note
Весь приведенный ниже порядок действий показан для версии QGIS 3.34, поэтому возможны небольшие расхождения в названиях функций/инструментов, если у вас установлена другая версия.
:::

# Исходные данные {#data}

В качестве исходных данных для работы будут использованы сведения о преступлениях в Сан-Франциско.

Все наборы данных доступен по [ссылке](https://geodacenter.github.io/data-and-lab/SFcrimes_vars/).

В скачанном архиве вы найдете две папки:

-   **Crime events** - векторные слои точечных объектов в формате shapefile для нескольких типов преступлений;

-   **SF PD Plots** - агрегированные по округам данные.

Так как темой занятия является анализ точечных паттернов, то вам понадобится один из слоев из папки *Crime events*:

-   *sf_cartheft.shp* - угоны машин;

-   *sf_drugs.shp* - случаи торговли наркотиками;

-   *sf_roberry.shp* - ограбления;

-   *sf_vandalism.shp* - случаи вандализма.

::: callout-warning
Не забывайте, что shapefile - это коварный формат и вам нужен не только файл с расширением *.shp*, но и все другие с таким же именем, но другими расширениями.
:::

| **Variable** | **Description** | Описание атрибута |
|:------------------|:---------------------------------|-------------------|
| IncidntNum | Unique identifier for each incident report | Идентификатор инцидента |
| X_pr | Projected X-coordinates | Координата Х в прямоугнольной системе координат |
| Y_pr | Projected Y-coordinates | Координата Y в прямоугнольной системе координат |
| Category | Crime classification (robberies, drugs/narcotics possession or sale, vehicle theft, and vandalism) | Тип преступления |
| Descript | Description of the crime | Описание |
| DayOfWeek | Day of the week that crime was reported | День недели, в который было подано заявление |
| Date | Date of the report | Дата заявления |
| Time | Time of report | Время заявления |
| PdDistrict | Police district | Полицейский участок |
| Resolution | Outcome of the report, e.g. None, Arrest, Unfounded, etc | Результат работы по заявлению |
| Location | Street address where the crime occurred | Название улицы, где произошло преступление |
| X | X-Coordinates of crime location | Долгота |
| Y | Y-Coordinates of crime location | Широта |

::: callout-tip
Открыть данные вы можете, просто перетащив файл с расширением *.shp* в пустое окно QGIS или через строку меню *Слой* $\longrightarrow$ Добавить слой $\longrightarrow$ Добавить векторный слой.
:::

После добавления векторного слоя и открытия подложки (опционально), вы должны увидеть что-то похожее на картинку ниже.

![](images/Снимок%20экрана%202025-02-18%20в%2011.23.06.png){fig-align="center"}

::: callout-note
Локальная оценка плотности по квадрантам рассмотрена по [ссылке](https://baltti.github.io/gis-itmo/spatial-basics.html#%D0%B0%D0%B3%D1%80%D0%B5%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D0%BE%D0%B2)
:::

# Ядерная оценка плотности {#kde}

::: callout-tip
Визуальную оценка ядерной плотности можно выполнить с помощью стилизации слоя точечных объектов в виде тепловой карты, о чем рассказано по [ссылке](https://baltti.github.io/gis-itmo/basics.html#%D1%82%D0%B5%D0%BF%D0%BB%D0%BE%D0%B2%D0%B0%D1%8F-%D0%BA%D0%B0%D1%80%D1%82%D0%B0). Однако в этом случае следует помнить, что полученная карта не является статичной и будет изменяться в зависимости от масштаба на экране, тогда как описанный ниже метод расчета даст статичную карту.
:::

Для построения карты ядерной оценки плотности воспользуемся инструментом *Тепловая карта (оценка плотности ядер)* из панели инструментов анализа.

::: callout-tip
Если у вас закрыта Панель инструментов анализа, то вы можете открыть ее заново из строки меню *Вид* $\longrightarrow$ *Панели* $\longrightarrow$ *Инструменты анализа*.
:::

В открывшемся окне инструмента следует выбрать параметры расчета[^1].

[^1]: Более подробно почитать про параметры можно по \[ссылке\](<https://docs.qgis.org/latest/en/docs/user_manual/processing_algs/qgis/interpolation.html>)

![](images/Снимок%20экрана%202025-02-19%20в%2010.45.03.png){fig-align="center"}

Рассмотрим основные параметры подробнее:

-   **точечный слой** - это векторный слой точечных объектов, для которого будет выполняться оценка плотности;

-   **радиус** - расстояние, в пределах которого будет рассчитываться значение функции плотности;

-   параметры размера растра - так как полученный результат будет представлен в виде непрерывных значений, он будет сформирован в виде растра, поэтому необходимо задать его основные параметры (чем больше строк и полей или чем меньше размер пикселя вы зададите, тем более подробным и качественным получится ваш результат).

Остальные параметры являются не обязательными для настройки, поэтому мы оставим их без изменений.

По умолчанию ваш результат будет сохранен в виде временного слоя, но вы можете настроить его сохранение в файл перед выполнением алгоритма или сохранить уже полученный временный слой.

::: callout-warning
Здесь при оценке плотности будут рассчитаны значения функции плотности только в пределах заданного радиуса, поэтому, если вы выберете слишком маленькую его величину, карта может быть не построена.
:::

В результате построения тепловой карты, вы получите следующее изображение (здесь радиус был взят 1000 футов и размер растра примерно 1000 на 1000).

![](images/Снимок%20экрана%202025-02-19%20в%2011.03.19.png){fig-align="center"}

![](images/Снимок экрана 2025-02-19 в 11.39.09.png){fig-align="center"}

# Оценка точечного паттерна

Для того, чтобы количественно оценить тип точечного паттерна, можно оценить разницу между ожидаемым средним расстоянием до ближашего соседа и фактическим.

![](images/AM07_Fig9.png){fig-align="center"}

[^2]

[^2]: Источник изображения: <https://gistbok-topics.ucgis.org/AM-03-007>

По результатам оценки наиболее важными параметрами являются:

-   *p-value* - вероятность того, что процесс является пространственно случайным;

-   *z-score* - стандартное отклонение распределения.

Как правило, высокие положительные значения *z-score* говорят о том, что точечный паттерн является регулярным, а низкие отрицательные значения - о том, что точечный паттерн кластеризован.

В QGIS эта оценка выполняется с помощью инструмента *Анализ ближайших соседей* из Панели инструментов анализа.

Для расчетов с его использованием достаточно только выбрать векторный точечный слой и вариант сохранения результата.

::: callout-note
Обратите внимание, что здесь сохранение результата будет происходить в формате html файла, а не уже привычного нам векторного или растрового слоя, так как здесь просто дается результат расчета численных показателей.
:::

![](images/Снимок экрана 2025-02-19 в 11.39.09.png){fig-align="center"}

Полученный результат в текстовом виде будет выглядеть вот так:

![](images/Снимок экрана 2025-02-19 в 11.43.40.png){fig-align="center"}

Рассмотрим полученные результаты:

-   наблюдаемое среднее расстояние - это среднее расстояние до ближайшего соседа;

-   ожидаемое среднее расстояние - это среднее расстояние до ближайшего соседа, которое было бы при случайном распределении точек;

-   индекс ближайшего соседа - отношение наблюдаемого расстояния к ожидаемому;

-   число точек - количество объектов в точечном слое;

-   z-счет - стандартное отклонение.
