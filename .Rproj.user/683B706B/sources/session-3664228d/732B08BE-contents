---
title: "Пространственные веса"
format: html
---

# Теория

Материалы лекции

```{=html}
<iframe src="https://baltti.github.io/spatial-weights/" width="800" height="400"></iframe>
```

[Открыть лекцию в новой вкладке](https://baltti.github.io/spatial-weights/){target="_blank"}

Материалы лекции (eng.)

```{=html}
<iframe src="https://baltti.github.io/spatial-weights-eng" width="800" height="400"></iframe>
```

[Открыть лекцию в новой вкладке](https://baltti.github.io/spatial-weights-eng/){target="_blank"}

# Программа GeoDa

**GeoDa** - это бесплатный программный инструмент с открытым исходным кодом, который служит для ознакомления с пространственной наукой о данных. Он разработан для того, чтобы способствовать получению новых выводов на основе анализа данных путем изучения и моделирования пространственных моделей.

![](images/esda.png){fig-align="center"}

Сайт программы: <https://geodacenter.github.io/> (на нем же можно скачать файл установки программы).

::: callout-tip
Ознакомиться с документацией можно по [ссылке](https://geodacenter.github.io/documentation.html).

```{=html}
<iframe width="560" height="315" src="https://www.youtube.com/embed/--8vhhmpgdM?si=l5NZLgepg2xaVY4C" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>

</iframe>
```
:::

Основной интерфейс программы состоит из панели инструментов и строки меню.

![Результаты анализа, карты и атрибутивные таблицы будут открываться в отдельных окнах.](images/Снимок%20экрана%202025-03-26%20в%2012.28.44.png){fig-align="center"}

GeoDa поддерживает основные векторные форматы пространственных данных, а также подключение к базам данных и использование векторных данных с веб-ресурсов в формате *.geojson* и *WFS*.

При запуске программы у вас появится окно открытия источника данных.

![](images/Снимок%20экрана%202025-03-26%20в%2012.44.31.png){fig-align="center"}

В том случае, если это окно не открылось, необходимый вам файл можно открыть по клику на значок ![](images/Снимок%20экрана%202025-03-26%20в%2014.49.38.png){width="37"}.

# Исходные данные

В качестве исходных данных будет использоваться набор данных о стоимости недвижимости в Санкт-Петербурге, который можно скачать по [ссылке](https://disk.yandex.ru/d/2pZazAW_vuxTuA).

::: callout-caution
Относитесь к этим данным как к синтетическим, так как их источник ненадежен.
:::

# Общие инструменты работы с данными

После того, как вы открыли файл с исходными данными, у вас появится окно карты.

![](images/Снимок%20экрана%202025-03-26%20в%2014.50.30.png)

В этой карте как и в прочих геоинформационных системах вы можете добавить подложку для контекста с использованием иконки ![](images/Снимок%20экрана%202025-03-26%20в%2014.50.52.png){width="48"}.

![](images/Снимок%20экрана%202025-03-26%20в%2014.51.01.png){fig-align="center"}

::: callout-tip
Кроме открытия слоя с имеющейся геометрией программа имеет функции по созданию геометрии точечного слоя из таблицы или создания сетки, а также пространственного объединения слоев (*Spatial join*) и слияния объектов (*Dissolve*).

![](images/Снимок%20экрана%202025-03-26%20в%2014.56.19.png){fig-align="center"}

Пространственное объединение позволяет объединять объекты из разных слоев, а слияние - объекты одного слоя по значению атрибута (например, мы могли бы так объединить муниципальные образования в районы).
:::

Настройка карты для визуализации показателя может быть осуществлена двумя способами:

-   через строку меню;

![](images/Снимок%20экрана%202025-04-02%20в%2014.07.03.png){fig-align="center"}

-   правым кликом на карте

![](images/Снимок%20экрана%202025-03-26%20в%2014.51.42.png){fig-align="center"}

Настройка здесь может быть осуществлена на основе стилей/тем по умолчанию, либо создана в виде кастомных интервалов.

![](images/Снимок%20экрана%202025-03-26%20в%2014.52.46.png){fig-align="center"}

::: callout-tip
На самом деле любой стиль по умолчанию можно подредактировать при необходимости и получить свой собственный стиль. Для этого нужно просто открыть редактор категорий ![](images/Снимок%20экрана%202025-03-26%20в%2014.57.37.png){width="36"}.

![](images/Снимок%20экрана%202025-03-26%20в%2014.53.31.png){fig-align="center"}
:::

::: callout-tip
При необходимости сохранения интервалов, вы можете это сделать, просто кликнув правой кнопкой мыши и выбрав *Save rates*. Тогда номера интервалов будут сохранены в атрибутивную таблицу.

![](images/Снимок%20экрана%202025-04-02%20в%2014.12.32.png){fig-align="center"}
:::

::: callout-note
Кроме обычной фоновой картограммы, также есть опция создания картограммы Дорлинга ![](images/Снимок%20экрана%202025-03-26%20в%2014.57.22.png), в которой все объекты будут заменены на круги различного диаметра в зависимости от значения показателя.

Причем отдельно здесь можно указать, что будет обозначать цвет символа, а что - его размер.

![](images/Снимок%20экрана%202025-04-02%20в%2014.32.37.png){fig-align="center"}

Полученная картограмма также может быть отдельно донастроена по цветовой палитре.

![](images/Снимок%20экрана%202025-04-02%20в%2014.33.38.png){fig-align="center"}
:::

Атрибутивную таблицу можно открыть в отдельном окне по клику на иконку ![](images/Снимок%20экрана%202025-03-26%20в%2014.54.48.png){width="40"}.

![](images/Снимок%20экрана%202025-03-26%20в%2014.54.59.png){fig-align="center"}

В строке меню есть отдельный пункт *Table*, который содержит в себе инструменты для работы с таблицами.

![](images/Снимок%20экрана%202025-03-26%20в%2014.55.12.png){fig-align="center"}

При необходимости вы можете добавлять или удалять атрибуты, а также редактировать типы данных в столбцах, если они были определены при открытии неправильно.

![](images/Снимок%20экрана%202025-03-26%20в%2014.55.35.png){fig-align="center"}

Для атрибутивной таблицы есть калькулятор полей, позволяющий осуществлять расчеты.

![](images/Снимок%20экрана%202025-03-26%20в%2014.55.53.png){fig-align="center"}

::: callout-note
Также в программе есть довольно большой выбор инструментов для исследовательского анализа данных, представленных в основной панели инструментов.

![](images/Снимок%20экрана%202025-04-02%20в%2012.56.43.png){fig-align="center"}
:::

# Расчет пространственных весов

Для создания матрицы пространственных весов необходимо воспользоваться менеджером весов ![](images/Снимок%20экрана%202025-04-02%20в%2015.03.14.png){width="44"}, также его можно открыть из строки меню.

![](images/Снимок%20экрана%202025-04-02%20в%2015.03.27.png){fig-align="center"}

В открывшемся окне менеджера весов вы увидите опции для создания новых и загрузки уже рассчитанных матриц пространственных весов.

![](images/Снимок%20экрана%202025-04-02%20в%2015.04.12.png){fig-align="center"}

После начала создания матрицы пространственных весов вы увидите окно, в котором можно выбрать тип рассчитаваемого веса.

![](images/Снимок%20экрана%202025-04-02%20в%2015.07.36.png){fig-align="center"}

::: callout-important
Очень важно, чтобы при создании матрицы весов у каждого объекта в наборе данных был уникальный идентификатор - порядковый номер, если такого идентификатора нет, то его можно просто создать *Add ID variable*.

![](images/Снимок%20экрана%202025-04-02%20в%2015.09.00.png){fig-align="center"}
:::

::: callout-note
Все матрицы весов сохраняются во внутреннем формате программы: два разных формата - один для матриц по смежности, второй - для матриц на основе расстояния. При необходимости они могут быть открыты просто в текстовом редакторе.
:::

## Расчет весов по смежности

### Принцип ферзя (королевы)

::: callout-important
Для того, чтобы объекты считались соседями, достаточно, чтобы у них была хотя бы одна общая точка.
:::

При создании весов по смежности достаточно выбрать используемый принцип смежности и порядок (мы везде по умолчанию используем только первый порядок соседства).

![](images/Снимок%20экрана%202025-04-02%20в%2015.13.07.png){fig-align="center"}

Параметр *Precision threshold* (порог точности) здесь нужен в том счучае, если вы сомневаетесь в качестве своих исходных данных и корректном примыкании пространственных объектов друг к другу, так как позволяет задать размер потенциального зазора или наложения.

После создания вам будет предложено сохранить матрицу весов в специализированном формате. Полученная матрица появится в менеджере весов.

![](images/Снимок%20экрана%202025-04-02%20в%2015.13.14.png){fig-align="center"}

В менеджере весов вы можете ознакомиться с параметрами каждой матрицы:

-   ее тип;

-   симметричность;

-   название файла, в котором она сохранена;

-   атрибут с порядковым номером;

-   порядок соседства (для матриц по смежности);

-   количество наблюдений;

-   минимальное и максимальное число соседей внутри набора данных;

-   среднее и медианное число соседей;

-   процент ненулевых элементов матрицы.

Кроме того, вы можете изучить матрицу весов визуально с помощью гистограммы, карты или графа связности.

На гистограмме высота столбцов показывает количество объектов, имеющее определенное число соседей, которое показано по оси X.

![](images/Снимок%20экрана%202025-04-02%20в%2015.17.55.png){fig-align="center"}

::: callout-tip
При выделении любого из столбиков вы сможете увидеть на карте, про какие именно объекты идет речь.

![](images/Снимок%20экрана%202025-04-02%20в%2015.20.50.png){fig-align="center"}
:::

Карта связности показывает выделенный объект, на который наведен курсор (зеленым цветом) и его соседей в соответствии с матрицей весов.

![](images/Снимок%20экрана%202025-04-02%20в%2015.22.05.png){fig-align="center"}

Граф связности же отображает топологические связи между объектами соседями.

![](images/Снимок%20экрана%202025-04-02%20в%2015.23.12.png){fig-align="center"}

При выделении одного из объектов на графе будут отображаться только его соседи.

![](images/Снимок%20экрана%202025-04-02%20в%2015.24.00.png){fig-align="center"}

::: callout-note
Если вы откроете матрицу пространственных весов в текстовом редакторе вы увидите только ее ненулевые элементы.

![](images/Снимок%20экрана%202025-04-02%20в%2015.30.47.png){fig-align="center"}
:::

### Принцип ладьи

::: callout-important
Для того, чтобы объекты считались соседями, между ними должна быть общая ненулевая граница (то есть общей точки здесь недостаточно).
:::

Построение матрицы весов по принципу ладьи происходит аналогично предыдущему пункту.

![](images/Снимок%20экрана%202025-04-02%20в%2015.25.31.png){fig-align="center"}

И после создания эта матрица также будет отображена в менеджере весов.

![](images/Снимок%20экрана%202025-04-02%20в%2015.26.10.png){fig-align="center"}

Аналогично матрице весов по принципу ферзя/королевы вы можете более подробно изучить структуру матрицы с помощью графиков:

-   гистограмма;

![](images/Снимок%20экрана%202025-04-02%20в%2015.28.07.png){fig-align="center"}

-   карта связности;

![](images/Снимок%20экрана%202025-04-02%20в%2015.28.38.png){fig-align="center"}

::: callout-note
Обратите внимание, что в нижней панели окна карты связности отображается номер объекта, на котором расположен курсор и номера его соседей.
:::

-   граф связности.

![](images/Снимок%20экрана%202025-04-02%20в%2015.29.32.png){fig-align="center"}

::: callout-important
Обратите внимание, что при использовании принципа ладьи вы получаете в среднем меньше соседей для каждого из объектов.
:::

::: callout-note
Также вы можете попробовать определить соседей по смежности, используя QGIS.

```{=html}
<iframe width="600" height="400" src="https://www.youtube.com/embed/c7lXotTM7vk?si=rDHN0VWZFlhMI_bh" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
```

Еще один вариант расчета ближайших соседей с использованием скрипта python для QGIS рассмотрен по [ссылке](https://gis.stackexchange.com/questions/227431/qgis-neighborhood-analysis).
:::

::: callout-note
Матрицы весов по смежности всегда будут симметричными относительно главной диагонали, что с точки зрения соседства значит, что объект $i$ будет соседом объекту $j$ и наоборот.
:::

## Расчет весов по расстоянию

При расчете весов по расстоянию необходимо задать значительно больше параметров.

![](images/Снимок%20экрана%202025-04-02%20в%2015.34.59.png){fig-align="center"}

В первую очередь следует указать, как и между чем будет рассчитываеться расстояние.

По умолчанию для полигональных объектов предлагается использовать центроиды по координатам, но эти же центроиды могут рассчитываться по значениям любого числового показателя. Кроме того для расчета расстояния не обязательно вообще использовать центроиды или пространственное положение объектов, вы можете воспользоваться любыми числовыми показателями вашей атрибутивной таблицы.

![](images/Снимок%20экрана%202025-04-02%20в%2015.37.45.png){fig-align="center"}

Расстояние может быть рассчитано двумя способами:

-   евклидово расстояние на плоскости;

-   расстояние на эллипсоиде (в милях или метрах).

Далее следует выбрать метод расчета весов по расстоянию и его параметры:

-   *distance band* (гибридные веса) - объекты будут считаться соседями, если расстояние между ними не превышает заданного. Здесь в качестве параметра необходимо задать это расстояние, по умолчанию устанавливается такая величина расстояния, которая гарантирует всем объектам как минимум одного соседа (максимальное расстояние между ближайшими объектами).

-   *k-ближайших соседей*, где необходимо задать необходимое число соседей;

-   *ядерные веса*, для которых вы можете выбрать:

    -   тип функции;

    -   необходимость применения ее только в пределах определенного расстояния (*specify bandwidth*);

    -   адаптивное расстояние, которое должно включать в себя определенное заданное число соседей;

    -   возможность использовать максимальное расстояние для заданного числа соседей как ширину полосы пропускания.

![](images/Снимок%20экрана%202025-04-02%20в%2015.44.04.png){fig-align="center"}

В текстовом виде матрицы весов будут выглядеть иначе:

![Матрица весов по расстоянию (гибридные веса)](images/Снимок экрана 2025-04-07 в 11.40.38.png){fig-align="center"}

![Матрица ядерных весов](images/Снимок экрана 2025-04-07 в 11.40.49.png){fig-align="center"}

Здесь уже не будут просто перечислены ненулевые элементы, то есть список соседей для каждого объекта, а расстояние для каждой пары соседей: в случае гибридных весов и $k$-ближайших соседей - расстояние (то, которое было рассчитано), а в случае ядерных весов - значение ядерной функции от расстояния.

![](images/Снимок экрана 2025-04-07 в 11.46.03.png){fig-align="center"}

::: callout-note
Попробуйте построить различные матрицы весов для разных параметров и сравнить их между собой.
:::

::: callout-note
Матрицы весов по расстоянию уже не будут симметричными, то есть объект $i$ может быть соседом объекту $j$, в то время как объект $j$ не будет являться соседом объекту $i$.
:::
