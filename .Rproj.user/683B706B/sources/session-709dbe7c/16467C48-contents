---
title: "Анализ точечных паттернов и кластеризация"
format: html
---

# Теория

Материалы лекции

```{=html}
<iframe src="https://baltti.github.io/point-pattern/" width="800" height="400"></iframe>
```

[Открыть лекцию в новой вкладке](https://baltti.github.io/point-pattern/){target="_blank"}

Материалы лекции (eng.)

```{=html}
<iframe src="https://baltti.github.io/point-pattern-eng/" width="800" height="400"></iframe>
```

[Открыть лекцию в новой](https://baltti.github.io/point-pattern/){target="_blank"}[вкладке](https://baltti.github.io/point-pattern-eng/){target="_blank"}

Для практической работы по теме используется геоинформационная система [QGIS](https://qgis.org/).

::: callout-note
Весь приведенный ниже порядок действий показан для версии QGIS 3.34, поэтому возможны небольшие расхождения в названиях функций/инструментов, если у вас установлена другая версия.
:::

# Исходные данные {#data}

В качестве исходных данных для работы будут использованы сведения о преступлениях в Сан-Франциско.

Все наборы данных доступен по [ссылке](https://geodacenter.github.io/data-and-lab/SFcrimes_vars/).

В скачанном архиве вы найдете две папки:

-   **Crime events** - векторные слои точечных объектов в формате shapefile для нескольких типов преступлений;

-   **SF PD Plots** - агрегированные по округам данные.

Так как темой занятия является анализ точечных паттернов, то вам понадобится один из слоев из папки *Crime events*:

-   *sf_cartheft.shp* - угоны машин;

-   *sf_drugs.shp* - случаи торговли наркотиками;

-   *sf_roberry.shp* - ограбления;

-   *sf_vandalism.shp* - случаи вандализма.

::: callout-warning
Не забывайте, что shapefile - это коварный формат и вам нужен не только файл с расширением *.shp*, но и все другие с таким же именем, но другими расширениями.
:::

| **Variable** | **Description** | Описание атрибута |
|:-----------------------|:-----------------------|------------------------|
| IncidntNum | Unique identifier for each incident report | Идентификатор инцидента |
| X_pr | Projected X-coordinates | Координата Х в прямоугнольной системе координат |
| Y_pr | Projected Y-coordinates | Координата Y в прямоугнольной системе координат |
| Category | Crime classification (robberies, drugs/narcotics possession or sale, vehicle theft, and vandalism) | Тип преступления |
| Descript | Description of the crime | Описание |
| DayOfWeek | Day of the week that crime was reported | День недели, в который было подано заявление |
| Date | Date of the report | Дата заявления |
| Time | Time of report | Время заявления |
| PdDistrict | Police district | Полицейский участок |
| Resolution | Outcome of the report, e.g. None, Arrest, Unfounded, etc | Результат работы по заявлению |
| Location | Street address where the crime occurred | Название улицы, где произошло преступление |
| X | X-Coordinates of crime location | Долгота |
| Y | Y-Coordinates of crime location | Широта |

::: callout-tip
Открыть данные вы можете, просто перетащив файл с расширением *.shp* в пустое окно QGIS или через строку меню *Слой* $\longrightarrow$ Добавить слой $\longrightarrow$ Добавить векторный слой.
:::

После добавления векторного слоя и открытия подложки (опционально), вы должны увидеть что-то похожее на картинку ниже.

![](images/Снимок%20экрана%202025-02-18%20в%2011.23.06.png){fig-align="center"}

::: callout-note
Локальная оценка плотности по квадрантам рассмотрена по [ссылке](https://baltti.github.io/gis-itmo/spatial-basics.html#%D0%B0%D0%B3%D1%80%D0%B5%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D0%BE%D0%B2)
:::

# Ядерная оценка плотности {#kde}

::: callout-tip
Визуальную оценка ядерной плотности можно выполнить с помощью стилизации слоя точечных объектов в виде тепловой карты, о чем рассказано по [ссылке](https://baltti.github.io/gis-itmo/basics.html#%D1%82%D0%B5%D0%BF%D0%BB%D0%BE%D0%B2%D0%B0%D1%8F-%D0%BA%D0%B0%D1%80%D1%82%D0%B0). Однако в этом случае следует помнить, что полученная карта не является статичной и будет изменяться в зависимости от масштаба на экране, тогда как описанный ниже метод расчета даст статичную карту.
:::

Для построения карты ядерной оценки плотности воспользуемся инструментом *Тепловая карта (оценка плотности ядер)* из панели инструментов анализа.

::: callout-tip
Если у вас закрыта Панель инструментов анализа, то вы можете открыть ее заново из строки меню *Вид* $\longrightarrow$ *Панели* $\longrightarrow$ *Инструменты анализа*.
:::

В открывшемся окне инструмента следует выбрать параметры расчета[^1].

[^1]: Более подробно почитать про параметры можно по [ссылке](https://docs.qgis.org/latest/en/docs/user_manual/processing_algs/qgis/interpolation.html)

![](images/Снимок%20экрана%202025-02-19%20в%2010.45.03.png){fig-align="center"}

Рассмотрим основные параметры подробнее:

-   **точечный слой** - это векторный слой точечных объектов, для которого будет выполняться оценка плотности;

-   **радиус** - расстояние, в пределах которого будет рассчитываться значение функции плотности;

-   параметры размера растра - так как полученный результат будет представлен в виде непрерывных значений, он будет сформирован в виде растра, поэтому необходимо задать его основные параметры (чем больше строк и полей или чем меньше размер пикселя вы зададите, тем более подробным и качественным получится ваш результат).

Остальные параметры являются не обязательными для настройки, поэтому мы оставим их без изменений.

По умолчанию ваш результат будет сохранен в виде временного слоя, но вы можете настроить его сохранение в файл перед выполнением алгоритма или сохранить уже полученный временный слой.

::: callout-warning
Здесь при оценке плотности будут рассчитаны значения функции плотности только в пределах заданного радиуса, поэтому, если вы выберете слишком маленькую его величину, карта может быть не построена.
:::

В результате построения тепловой карты, вы получите следующее изображение (здесь радиус был взят 1000 футов и размер растра примерно 1000 на 1000).

![](images/Снимок%20экрана%202025-02-19%20в%2011.03.19.png){fig-align="center"}

![](images/Снимок%20экрана%202025-02-19%20в%2011.39.09.png){fig-align="center"}

# Оценка точечного паттерна

Для того, чтобы количественно оценить тип точечного паттерна, можно оценить разницу между ожидаемым средним расстоянием до ближашего соседа и фактическим.

![](images/AM07_Fig9.png){fig-align="center"}

[^2]

[^2]: Источник изображения: <https://gistbok-topics.ucgis.org/AM-03-007>

По результатам оценки наиболее важными параметрами являются:

-   *p-value* - вероятность того, что процесс является пространственно случайным;

-   *z-score* - стандартное отклонение распределения.

Как правило, высокие положительные значения *z-score* говорят о том, что точечный паттерн является регулярным, а низкие отрицательные значения - о том, что точечный паттерн кластеризован.

В QGIS эта оценка выполняется с помощью инструмента *Анализ ближайших соседей* из Панели инструментов анализа.

Для расчетов с его использованием достаточно только выбрать векторный точечный слой и вариант сохранения результата.

::: callout-note
Обратите внимание, что здесь сохранение результата будет происходить в формате html файла, а не уже привычного нам векторного или растрового слоя, так как здесь просто дается результат расчета численных показателей.
:::

![](images/Снимок%20экрана%202025-02-19%20в%2011.39.09.png){fig-align="center"}

Полученный результат в текстовом виде будет выглядеть вот так:

![](images/Снимок%20экрана%202025-02-19%20в%2011.43.40.png){fig-align="center"}

Рассмотрим полученные результаты:

-   *наблюдаемое среднее расстояние* - это среднее расстояние до ближайшего соседа;

-   *ожидаемое среднее расстояние* - это среднее расстояние до ближайшего соседа, которое было бы при случайном распределении точек;

-   *индекс ближайшего соседа* - отношение наблюдаемого расстояния к ожидаемому;

-   *число точек* - количество объектов в точечном слое;

-   *z-счет* - стандартное отклонение.

В соответствии с [документацией](https://docs.qgis.org/3.34/ru/docs/user_manual/processing_algs/qgis/vectoranalysis.html#nearest-neighbour-analysis), отрицательные значения говорят о том, что точечный паттерн не является результатом пространственно случайного процесса, тогда как положительные значения могут говорить о том, что процесс скорее регулярен.

![](images/Снимок%20экрана%202025-02-19%20в%2016.20.54.png){fig-align="center"}

::: callout-warning
Полученный результат только говорит о возможности пространственной неслучайности процесса. Наличие конкретных кластеров или регулярность паттерна требует дальнейшей проверки и интерпретации.
:::

В нашем случае, было получено значение *z-score* = -90.5, что говорит о том, что точечный паттерн скорее всего является кластеризованным.

# Кластеризация К-средних

Как было рассмотрено в лекции, кластеризация методом К-средних позволяет получить обособленные друг от друга кластеры, внутри которых будет минимизироваться расстояние от каждого из объектов до центроида кластера (при этом центроид не будет является одним из исходных объектов, а просто будет центром массы всего кластера).

В QGIS этот метод реализован в виде инструмента *Кластеризация K-means* в Панели инструментов анализа.

![](images/Снимок%20экрана%202025-02-20%20в%2011.26.20.png){fig-align="center"}

Для выполнения алгоритма достаточно просто выбрать векторный слой с точечными данными для кластеризации и необходимое количество кластеров.

::: callout-note
Для кластеризации не обязательно использовать только точечные объекты, ее можно выполнить также для линейных и полигональных объектов, но в этих случаях кластеризация будет выполняться не непосредственно для них, а для их центроидов.
:::

::: callout-note
В нашем случае количество кластеров выбирается произвольно, однако существуют определенные методы расчета наиболее оптимального числа кластеров. Почитать про эти методы можно почитать, например, [здесь](https://habr.com/ru/companies/jetinfosystems/articles/467745/).
:::

В качестве дополнительных параметров алгоритма можно задать свои имена для полей с номером кластера и размером кластера.

По результатам кластеризации вы получите точечный слой, главным отличием которого от исходного будут являться два новых поля:

-   *CLUSTER_ID -* порядковый номер кластера (начинаются с 0, так как индексация здесь унаследована от языка программирования);
-   *CLUSTER-SIZE* - размер кластера (количество точек в нем).

Для того, чтобы показать, где расположены точки каждого из кластеров на карте, настроим их символы в окне Свойств слоя. В качестве типа стиля следует выбрать *Символизация по уникальным значениям*, а в качестве значения - *CLUSTER_ID.*

![](images/Снимок%20экрана%202025-02-20%20в%2011.35.25.png){fig-align="center"}

После этого каждый кластер получит свой цвет на карте.

![](images/Снимок%20экрана%202025-02-20%20в%2011.36.58.png){fig-align="center"}

Кластеризация методом К-средних позволяет сформировать обособленные и компактные кластеры. Проверим, действительно ли это так. Для проверки впишем каждый кластер в выпуклый многоугольник.

Если кластеры действительно компактны и обособлены друг от друга, то полученные многоугольники не будут соприкасаться или пересекаться.

Для построения выпуклых многоугольников воспользуемся инструментом *Минимальная охватывающая геометрия* из Панели инструментов анализа. Он позволяет построить нужный тип минимальной охватывающей геометрии.

![](images/Снимок%20экрана%202025-02-20%20в%2011.53.46.png){fig-align="center"}

В качестве параметров здесь следует выбрать

-   слой, для объектов которого будет строиться минимальная охватывающая геометрия;

-   поле классификации - то поле/атрибут, на основе которого объекты будут объединяться в группы для построения минимальной охватывающей геометрии;

-   тип геометрии - так как мы хотим получить выпуклые многоугольники вокруг каждого кластера, то нужный тип геометрии - выпуклая оболочка; другие типы геометрии - *охват* (прямоугольник по минимальным и максимальным координатам слоя), *минимальный ориентированный прямоугольник* (прямоугольник, ориентированный с учетом разброса наблюдений), *минимальная описывающая окружность*.

![](images/Снимок%20экрана%202025-02-20%20в%2011.53.59.png){fig-align="center"}

В результате будет построен новый векторный слой с полигонами - выпуклыми многоугольниками, описывающими каждый кластер.

![](images/Снимок%20экрана%202025-02-20%20в%2011.58.43.png){fig-align="center"}

::: callout-note
Факт того, что полученные выпуклые многоугольники не пересекаются между собой, говорит о том, что кластеры обособлены друг от друга.
:::

::: callout-note
На этой карте вы можете заметить еще и то, что некоторые обособленные точки (например, на острове в правом верхнем углу или в левой части) перетягивают в свою сторону центроиды кластеров, что может разбить некоторые довольно плотные группы.
:::

# Кластеризация DBSCAN

Ввиду того, что метод кластеризации К-средних всегда все точки отнесет к тому или иному кластеру, что может привести к некорректной разбивке на группы, он может показывать неудовлетворительные результаты на реальных данных, в которых может присутствовать шум и выбросы.

В этих случаях более оптимальным методом кластеризации будет основанный на плотности DBSCAN (Density-based spatial clustering of applications with noise).

В QGIS этот алгоритм реализован в виде инструмента *Кластеризация DBSCAN*.

![](images/Снимок%20экрана%202025-02-20%20в%2012.18.50.png){fig-align="center"}

Основными параметрами являются:

-   *векторный слой* с объектами, для которых выполняется кластеризация;
-   *минимальный размер кластера* - минимальное количество соседей в пределах заданного расстояния, при котором точка будет включена в ядро кластера;
-   *максимальное расстояние между кластеризованными точками* - расстояние, в пределах которого будет осуществляться поиск соседей для каждой их точек.

Дополнительными параметрами так же, как и для кластеризации К-средних будут являться *CLUSTER_ID* и *CLUSTER-SIZE*, а кроме того - возможность рассматривать граничные точки в качестве шума.

::: callout-note
Как и для кластеризации методом К-средних параметры в нашем случае были выбраны произвольно, но в случае реального исследования они должны быть обоснованы, исходя из знания предметной области и природы простраственного процесса.
:::

В результате снова получим векторный слой с точечными объектами и двумя новыми атрибутами *CLUSTER_ID* и *CLUSTER-SIZE.* Обратите внимание, что для некоторых из точек будут пропущены значения этих полей, это значит, что точка не попала ни в один из кластеров и является точкой шума.

Аналогично предыдущему разделу покажем кластеры на карте разными цветами.

![](images/Снимок%20экрана%202025-02-20%20в%2012.29.58.png){fig-align="center"}

На карте видно, что в результате нами были получены небольшие кластеры в местах с наибольшей плотностью наблюдений, тогда как значительное число точек было отнесено к точкам шума, то есть не вошло ни в один из кластеров.

![Кластеры](images/Снимок%20экрана%202025-02-20%20в%2012.33.12.png){fig-align="center"}

![Точки шума](images/Снимок%20экрана%202025-02-20%20в%2012.33.27.png){fig-align="center"}

Для проверки наличия пересечений между кластерами можно аналогично предыдущему разделу построить минимальные охватывающие геометрии каждого из кластеров.

::: callout-tip
Также имеющаяся в стандартном наборе Панели инструментов анализа кластеризация ST-DBSCAN является вариацией метода DBSCAN, в котором дополнительно учитывается время события. Такой метод кластеризации полезен, если вы знаете или предполагаете, что точечный процесс происходит с разной интенсивностью в разные временные периоды или происходит преимущественно в определенные периоды времени.

Подробно метод описан в [статье](https://www.sciencedirect.com/science/article/abs/pii/S0169023X06000218)
:::
